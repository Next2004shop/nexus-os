openapi: 3.0.3
info:
  title: Nexus Trading API
  version: "1.0.0"
  description: >
    Private Nexus Trading API â€” local-only / private deployment.
    STRICT: Admin endpoints require RS256-signed JWT (aud=nexus-control).
    Do NOT expose this API publicly. Use localhost or private VPN only.

servers:
  - url: https://localhost:8443
    description: Local (default). Restrict access to device / private network.

security:
  - LocalApiKey: []
components:
  securitySchemes:
    LocalApiKey:
      type: apiKey
      in: header
      name: X-API-KEY
      description: "Local API key for device-bound requests. Store off-device and rotate."
    AdminJwt:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: "RS256 signed JWT. Audience must be 'nexus-control'. Issuer must be an approved admin identifier."
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
        ts:
          type: string
          format: date-time
    VersionResponse:
      type: object
      properties:
        latest_android_version:
          type: string
        android_apk:
          type: string
        android_apk_sig:
          type: string
        latest_desktop_version:
          type: string
        desktop_exe:
          type: string
        desktop_exe_sig:
          type: string
        min_version:
          type: string
        notes:
          type: string
    PredictRequest:
      type: object
      required:
        - asset
        - timeframe
        - mode
      properties:
        asset:
          type: string
          example: BTC-USD
        timeframe:
          type: string
          example: "1h"
        mode:
          type: string
          enum: [Scout, Hunter, Titan, Oracle]
        context:
          type: object
          description: "Optional context (account balances, recent trades, user preferences)."
    PredictResponse:
      type: object
      required:
        - asset
        - direction
        - confidence
      properties:
        asset:
          type: string
        direction:
          type: string
          enum: [UP, DOWN]
        strength:
          type: string
          enum: [Weak, Medium, Strong]
        confidence:
          type: number
          format: float
          minimum: 0
          maximum: 1
        timeframe:
          type: string
        entry:
          type: number
        stop_loss:
          type: number
        take_profit:
          type: number
        risk_rating:
          type: string
          enum: [Low, Medium, High]
        reason:
          type: string
        model_version:
          type: string
        timestamp:
          type: string
          format: date-time
    ControlState:
      type: object
      properties:
        kill_switch:
          type: boolean
        min_version:
          type: string
        force_update:
          type: boolean
        note:
          type: string
    ControlSetRequest:
      type: object
      properties:
        kill_switch:
          type: boolean
        min_version:
          type: string
        force_update:
          type: boolean
    LogEntry:
      type: object
      required:
        - level
        - payload
      properties:
        level:
          type: string
          enum: [info, warn, error]
        payload:
          type: string
          description: "AES-GCM encrypted payload (base64)."
        ts:
          type: string
          format: date-time
    BacktestRequest:
      type: object
      required:
        - strategy
        - asset
        - from
        - to
      properties:
        strategy:
          type: string
        asset:
          type: string
        from:
          type: string
          format: date
        to:
          type: string
          format: date
    BacktestResponse:
      type: object
      properties:
        report_url:
          type: string
        metrics:
          type: object
          description: "CAGR, max_drawdown, sharpe, win_rate, avg_win, avg_loss, profit_factor"

paths:
  /health:
    get:
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /version.json:
    get:
      summary: Client version manifest (signed references)
      description: "Return signed URIs and min version. Clients must verify signatures locally."
      responses:
        '200':
          description: Version manifest
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionResponse'

  /predict:
    post:
      summary: Get model prediction for an asset/timeframe
      security:
        - LocalApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PredictRequest'
      responses:
        '200':
          description: Prediction result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PredictResponse'
        '401':
          description: Unauthorized
        '400':
          description: Bad request

  /control/state:
    get:
      summary: Read control state (kill switch, min_version)
      security:
        - AdminJwt: []
      responses:
        '200':
          description: Current control state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ControlState'
        '401':
          description: Unauthorized

  /control/set:
    post:
      summary: Update control state (admin only)
      description: "Admin must send RS256-signed JWT. The JWT payload may also include command for audit trail."
      security:
        - AdminJwt: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ControlSetRequest'
      responses:
        '200':
          description: Updated state
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  state:
                    $ref: '#/components/schemas/ControlState'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden

  /logs:
    post:
      summary: Ingest encrypted log entry (local)
      security:
        - LocalApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogEntry'
      responses:
        '200':
          description: Log accepted
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean

  /backtest/run:
    post:
      summary: Run backtest (local; heavy job)
      security:
        - LocalApiKey: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BacktestRequest'
      responses:
        '200':
          description: Backtest scheduled / report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BacktestResponse'
        '400':
          description: Bad request
        '429':
          description: Rate limited (only allow local device or internal queue)

components:
  parameters: {}
tags:
  - name: core
    description: Core prediction and control endpoints
externalDocs:
  description: Nexus internal docs
  url: https://localhost:8443/docs
